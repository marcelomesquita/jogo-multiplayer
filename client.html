<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>Jogo</title>

	<style>
		#screen {
			border: 1px solid #cccccc;
			image-rendering: pixelated;
			width: 300px;
			height: 300px;
		}
	</style>
</head>

<body>
	<canvas id="screen" width="30" height="30"></canvas>

	<script>
		const screen = document.getElementById('screen');
		const context = screen.getContext('2d');
		const me = 'Marcelo';

		function renderScreen() {
			// context.fillStyle = 'white';
			context.clearRect(0, 0, screen.width, screen.height);

			for (const id in game.state.players) {
				const player = game.state.players[id];

				context.fillStyle = 'black';
				context.fillRect(player.x, player.y, 1, 1);
			}

			for (const id in game.state.fruits) {
				const fruit = game.state.fruits[id];

				context.fillStyle = 'green';
				context.fillRect(fruit.x, fruit.y, 1, 1);
			}

			requestAnimationFrame(renderScreen);
		}

		function createKeyboardListener() {
			const state = {
				observers: []
			}

			function subscribe(observer) {
				state.observers.push(observer);
			}

			function notifyAll(command) {
				for (const observer of state.observers) {
					observer(command);
				}
			}

			document.addEventListener('keydown', handleKeyDown);

			function handleKeyDown(event) {
				// console.log(event.key);
				notifyAll({ id: me, key: event.key });
			}

			return {
				subscribe
			}
		}

		function createGame() {
			const state = {
				players: {},
				fruits: {}
			}

			function addPlayer(command) {
				state.players[command.id] = {
					x: command.x,
					y: command.y
				}
			}

			function removePlayer(command) {
				delete state.players[command.id];
			}

			function addFruit(command) {
				state.fruits[command.id] = {
					x: command.x,
					y: command.y
				}
			}

			function removeFruit(command) {
				delete state.fruits[command.id];
			}

			function movePlayer(command) {
				const acceptedMoves = {
					ArrowUp(player) {
						player.y = Math.max(player.y - 1, 0);
					},
					ArrowDown(player) {
						player.y = Math.min(player.y + 1, screen.height - 1);
					},
					ArrowLeft(player) {
						player.x = Math.max(player.x - 1, 0);
					},
					ArrowRight(player) {
						player.x = Math.min(player.x + 1, screen.width - 1);
					},
				}

				const player = game.state.players[command.id];
				const moveFunction = acceptedMoves[command.key];

				if (player && moveFunction) {
					moveFunction(player);
					checkFruitCollision(player);
				}
			}

			function checkFruitCollision(player) {
				for (const fruitId in state.fruits) {
					const fruit = state.fruits[fruitId];

					if (player.x == fruit.x && player.y == fruit.y) {
						console.log('nham');
						removeFruit({ id: fruitId });
					}
				}
			}

			return {
				state,
				addPlayer,
				removePlayer,
				addFruit,
				removeFruit,
				movePlayer,
				checkFruitCollision
			}
		}

		const game = createGame();
		const keyboardListener = createKeyboardListener();

		game.addPlayer({ id: 'Marcelo', x: 0, y: 0 });
		game.addPlayer({ id: 'Fernanda', x: 1, y: 0 });
		game.addPlayer({ id: 'Maria', x: 2, y: 0 });
		game.addFruit({ id: 'fruit1', x: 15, y: 15 });

		keyboardListener.subscribe(game.movePlayer);

		renderScreen();
	</script>
</body>

</html>